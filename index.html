<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist H√†ng Ng√†y - H√≥a Gi·∫£i T·ª≠ Vi</title>
    <style>
        @media print {
            body { margin: 0; }
            .no-print { display: none; }
            .page-break { page-break-after: always; }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .date-box {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #667eea;
        }
        
        .date-box label {
            font-weight: bold;
            color: #667eea;
            margin-right: 10px;
        }
        
        .date-box input {
            border: none;
            background: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
            width: 150px;
        }

        .saved-badge {
            display: inline-block;
            margin-left: 12px;
            padding: 6px 10px;
            background: #e6ffed;
            color: #087f5b;
            border-radius: 12px;
            font-size: 13px;
            border: 1px solid #b7f5d0;
            vertical-align: middle;
            opacity: 0;
            transition: opacity 0.25s ease-in-out;
        }
        
        .section {
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
            padding-left: 15px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .section-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .time-label {
            display: inline-block;
            background: #ffd700;
            color: #333;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .checklist-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .checklist-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .checklist-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .checklist-item label {
            cursor: pointer;
            flex-grow: 1;
            line-height: 1.6;
        }
        
        .priority-high { border-left: 4px solid #dc3545; }
        .priority-medium { border-left: 4px solid #ffc107; }
        .priority-low { border-left: 4px solid #28a745; }
        
        .notes-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff9e6;
            border-radius: 10px;
            border: 2px dashed #ffc107;
        }
        
        .notes-section h3 {
            color: #ff8c00;
            margin-bottom: 10px;
        }
        
        .notes-section textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        /* History styles */
        .history-section {
            margin-top: 30px;
            padding: 20px;
            background: #f4f7fb;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .history-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .history-list {
            max-height: 260px;
            overflow: auto;
            border-radius: 6px;
            background: white;
            padding: 10px;
            border: 1px solid #e6eef8;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px dashed #eef3fb;
            font-size: 14px;
        }

        .history-item.old-90 {
            background: #fff1f0;
            border-left: 4px solid #dc3545;
        }

        .small-muted { font-size: 12px; color: #666; }
        
        .quote {
            text-align: center;
            font-style: italic;
            color: #666;
            margin: 30px 0;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            gap: 15px;
        }
        
        .stat-box {
            flex: 1;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .print-btn {
            display: block;
            width: 200px;
            margin: 30px auto;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .print-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }
        
        .emergency-box {
            background: #ffe6e6;
            border: 3px solid #dc3545;
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
        }
        
        .emergency-box h3 {
            color: #dc3545;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .emergency-box ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .emergency-box li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåü CHECKLIST H√ÄNG NG√ÄY üåü</h1>
        <div class="subtitle">H√≥a gi·∫£i Ph√° Qu√¢n ‚Ä¢ Nu√¥i d∆∞·ª°ng Thi√™n C∆° ‚Ä¢ X√¢y d·ª±ng T·ª≠ Vi</div>
        
        <div class="date-box">
            <label>üìÖ Ng√†y:</label>
            <input type="date" id="dateInput">
            <span id="savedBadge" class="saved-badge">ƒê√£ l∆∞u</span>
            <label style="margin-left: 20px;">üî¢ Ng√†y th·ª©:</label>
            <input type="number" id="dayNumber" placeholder="1" min="1" max="90" style="width: 80px;">
            <span>/90</span>
        </div>

        <div class="stats no-print">
            <div class="stat-box">
                <span class="stat-number" id="completedToday">0</span>
                <span class="stat-label">Ho√†n th√†nh h√¥m nay</span>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="totalTasks">24</span>
                <span class="stat-label">T·ªïng nhi·ªám v·ª•</span>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="percentComplete">0%</span>
                <span class="stat-label">Ti·∫øn ƒë·ªô</span>
            </div>
        </div>

        <!-- BU·ªîI S√ÅNG -->
        <div class="section">
            <div class="section-title">
                <span class="section-icon">üåÖ</span>
                BU·ªîI S√ÅNG (6h-9h)
                <span class="time-label">V√ÄNG NƒÇNG L∆Ø·ª¢NG</span>
            </div>
            
            <div class="checklist-item priority-high">
                <input type="checkbox" id="morning1" onchange="updateStats()">
                <label for="morning1">
                    <strong>Nghi th·ª©c Th√°i D∆∞∆°ng:</strong> Ra ban c√¥ng h∆∞·ªõng ƒê√¥ng, ƒë√≥n √°nh m·∫∑t tr·ªùi, th·ªü s√¢u 9 l·∫ßn, n√≥i kh·∫≥ng ƒë·ªãnh: "H√¥m nay t√¥i t·ªèa s√°ng nh∆∞ m·∫∑t tr·ªùi, ti·ªÅn b·∫°c t·ª± nhi√™n ƒë·∫øn v·ªõi t√¥i"
                </label>
            </div>
            
            <div class="checklist-item priority-high">
                <input type="checkbox" id="morning2" onchange="updateStats()">
                <label for="morning2">
                    <strong>U·ªëng 500ml n∆∞·ªõc ·∫•m + 1 vi√™n Omega-3:</strong> Thanh l·ªçc c∆° th·ªÉ, b√¥i tr∆°n n√£o b·ªô
                </label>
            </div>
            
            <div class="checklist-item priority-medium">
                <input type="checkbox" id="morning3" onchange="updateStats()">
                <label for="morning3">
                    <strong>Vi·∫øt 3 ƒëi·ªÅu bi·∫øt ∆°n h√¥m nay:</strong> L·∫≠p tr√¨nh n√£o b·ªô t√≠ch c·ª±c ngay t·ª´ ƒë·∫ßu ng√†y
                </label>
            </div>
            
            <div class="checklist-item priority-low">
                <input type="checkbox" id="morning4" onchange="updateStats()">
                <label for="morning4">
                    <strong>ƒÇn s√°ng gi√†u Omega-3:</strong> Ch√°o y·∫øn m·∫°ch + h·∫°t √≥c ch√≥ + chu·ªëi + tr√† xanh (kh√¥ng c√† ph√™!)
                </label>
            </div>
        </div>

        <!-- BU·ªîI TR∆ØA -->
        <div class="section">
            <div class="section-title">
                <span class="section-icon">‚òÄÔ∏è</span>
                BU·ªîI TR∆ØA (12h-14h)
            </div>
            
            <div class="checklist-item priority-medium">
                <input type="checkbox" id="noon1" onchange="updateStats()">
                <label for="noon1">
                    <strong>Ngh·ªâ tr∆∞a 20 ph√∫t (n·∫øu ƒë∆∞·ª£c):</strong> N·∫°p nƒÉng l∆∞·ª£ng cho n√£o Thi√™n C∆°
                </label>
            </div>
            
            <div class="checklist-item priority-low">
                <input type="checkbox" id="noon2" onchange="updateStats()">
                <label for="noon2">
                    <strong>ƒêi b·ªô 10 ph√∫t sau b·ªØa tr∆∞a:</strong> Gi√∫p ti√™u h√≥a + gi·∫£m cƒÉng th·∫≥ng
                </label>
            </div>
        </div>

        <!-- BU·ªîI CHI·ªÄU -->
        <div class="section">
            <div class="section-title">
                <span class="section-icon">üïí</span>
                BU·ªîI CHI·ªÄU (14h-18h)
            </div>
            
            <div class="checklist-item priority-high">
                <input type="checkbox" id="afternoon1" onchange="updateStats()">
                <label for="afternoon1">
                    <strong>15h-15h30: WORRY WINDOW!</strong> ƒê·ªçc danh s√°ch lo l·∫Øng t·ª´ s√°ng ‚Üí Lo t·∫≠p trung 30 ph√∫t ‚Üí H·∫æT GI·ªú!
                </label>
            </div>
            
            <div class="checklist-item priority-medium">
                <input type="checkbox" id="afternoon2" onchange="updateStats()">
                <label for="afternoon2">
                    <strong>U·ªëng tr√† xanh + ƒÉn snack l√†nh m·∫°nh:</strong> H·∫°t √≥c ch√≥/h·∫°nh nh√¢n/qu·∫£ vi·ªát qu·∫•t (tr√°nh ƒë∆∞·ªùng!)
                </label>
            </div>
            
            <div class="checklist-item priority-low">
                <input type="checkbox" id="afternoon3" onchange="updateStats()">
                <label for="afternoon3">
                    <strong>K·ªπ thu·∫≠t Pomodoro:</strong> L√†m vi·ªác 25 ph√∫t ‚Üí Ngh·ªâ 5 ph√∫t (gi·∫£m qu√° t·∫£i n√£o)
                </label>
            </div>
        </div>

        <!-- BU·ªîI T·ªêI -->
        <div class="section">
            <div class="section-title">
                <span class="section-icon">üåÜ</span>
                BU·ªîI T·ªêI (18h-20h)
            </div>
            
            <div class="checklist-item priority-high">
                <input type="checkbox" id="evening1" onchange="updateStats()">
                <label for="evening1">
                    <strong>V·∫≠n ƒë·ªông 30 ph√∫t:</strong> Ch·∫°y b·ªô/Yoga/V√µ thu·∫≠t/ƒê·∫•m bao c√°t (x·∫£ Ph√° Qu√¢n!)
                </label>
            </div>
            
            <div class="checklist-item priority-medium">
                <input type="checkbox" id="evening2" onchange="updateStats()">
                <label for="evening2">
                    <strong>ƒÇn t·ªëi nh·∫π tr∆∞·ªõc 19h:</strong> S√∫p + rau c·ªß + protein √≠t b√©o (tr√°nh ƒÉn no qu√°!)
                </label>
            </div>
            
            <div class="checklist-item priority-low">
                <input type="checkbox" id="evening3" onchange="updateStats()">
                <label for="evening3">
                    <strong>N√≥i chuy·ªán v·ªõi ng∆∞·ªùi th·∫≠t 15 ph√∫t:</strong> G·∫∑p m·∫∑t/g·ªçi ƒëi·ªán (KH√îNG CHAT!) - Ch·ªëng c√¥ l·∫≠p
                </label>
            </div>
        </div>

        <!-- BU·ªîI KHUYA -->
        <div class="section">
            <div class="section-title">
                <span class="section-icon">üåô</span>
                BU·ªîI KHUYA (21h-23h)
                <span class="time-label">QUAN TR·ªåNG NH·∫§T!</span>
            </div>
            
            <div class="checklist-item priority-high">
                <input type="checkbox" id="night1" onchange="updateStats()">
                <label for="night1">
                    <strong>21h: BRAIN DUMP!</strong> Vi·∫øt li√™n t·ª•c 15 ph√∫t m·ªçi suy nghƒ© ‚Üí ƒê√≥ng s·ªï ‚Üí N√≥i "ƒê·ªÉ ng√†y mai lo" ‚Üí Kh√≥a v√†o ngƒÉn k√©o
                </label>
            </div>
            
            <div class="checklist-item priority-high">
                <input type="checkbox" id="night2" onchange="updateStats()">
                <label for="night2">
                    <strong>Ki·ªÉm tra T√ÄI CH√çNH:</strong> Ghi thu chi h√¥m nay ‚Üí Chuy·ªÉn % v√†o 3 H≈© V√†ng (n·∫øu c√≥ thu nh·∫≠p)
                </label>
            </div>
            
            <div class="checklist-item priority-high">
                <input type="checkbox" id="night3" onchange="updateStats()">
                <label for="night3">
                    <strong>22h: T·∫Øm n∆∞·ªõc ·∫•m + tinh d·∫ßu o·∫£i h∆∞∆°ng:</strong> T·∫≠p trung 100% v√†o c·∫£m gi√°c (Sensory Overload)
                </label>
            </div>
            
            <div class="checklist-item priority-high">
                <input type="checkbox" id="night4" onchange="updateStats()">
                <label for="night4">
                    <strong>22h30: Body Scan tr√™n gi∆∞·ªùng:</strong> Qu√©t t·ª´ ng√≥n ch√¢n ‚Üí ƒë·∫ßu (m·ªói b·ªô ph·∫≠n 30s)
                </label>
            </div>
            
            <div class="checklist-item priority-medium">
                <input type="checkbox" id="night5" onchange="updateStats()">
                <label for="night5">
                    <strong>U·ªëng 1 vi√™n Magie 400mg + tr√† hoa c√∫c:</strong> Th∆∞ gi√£n th·∫ßn kinh, ng·ªß s√¢u h∆°n
                </label>
            </div>
            
            <div class="checklist-item priority-low">
                <input type="checkbox" id="night6" onchange="updateStats()">
                <label for="night6">
                    <strong>Vi·∫øt 3 ƒëi·ªÅu may m·∫Øn v·ªÅ ti·ªÅn b·∫°c h√¥m nay:</strong> D√π nh·ªè (t√¨m ƒë∆∞·ª£c 5k, ƒë∆∞·ª£c m·ªùi cafe...)
                </label>
            </div>
            
            <div class="checklist-item priority-low">
                <input type="checkbox" id="night7" onchange="updateStats()">
                <label for="night7">
                    <strong>T·∫ÆT HO√ÄN TO√ÄN ƒëi·ªán tho·∫°i/laptop:</strong> ƒê·ªÉ xa gi∆∞·ªùng √≠t nh·∫•t 2m (KH√îNG ƒê∆Ø·ª¢C ph√° quy t·∫Øc!)
                </label>
            </div>
        </div>

        <!-- M·ªåI L√öC -->
        <div class="section">
            <div class="section-title">
                <span class="section-icon">‚è∞</span>
                M·ªåI L√öC TRONG NG√ÄY
            </div>
            
            <div class="checklist-item priority-high">
                <input type="checkbox" id="anytime1" onchange="updateStats()">
                <label for="anytime1">
                    <strong>Trigger Log:</strong> M·ªói khi mu·ªën ph√° ho·∫°i ‚Üí Ghi l·∫°i: Gi·ªù/C·∫£m x√∫c/Mu·ªën ph√° g√¨/L√Ω do th·∫≠t
                </label>
            </div>
            
            <div class="checklist-item priority-high">
                <input type="checkbox" id="anytime2" onchange="updateStats()">
                <label for="anytime2">
                    <strong>Quy t·∫Øc 30 ng√†y ch·ªù ƒë·ª£i:</strong> N·∫øu mu·ªën quy·∫øt ƒë·ªãnh l·ªõn (b·ªè vi·ªác/chia tay...) ‚Üí Vi·∫øt ra ‚Üí CH·ªú 30 NG√ÄY!
                </label>
            </div>
            
            <div class="checklist-item priority-medium">
                <input type="checkbox" id="anytime3" onchange="updateStats()">
                <label for="anytime3">
                    <strong>Khi lo √¢u t·∫•n c√¥ng:</strong> Th·ª±c hi·ªán Emergency Plan: Th·ªü 4-7-8 x5 ‚Üí N∆∞·ªõc l·∫°nh ‚Üí ƒêi b·ªô 15' ‚Üí Vi·∫øt 3 trang
                </label>
            </div>
            
            <div class="checklist-item priority-medium">
                <input type="checkbox" id="anytime4" onchange="updateStats()">
                <label for="anytime4">
                    <strong>Cognitive Defusion:</strong> Khi suy nghƒ© ti√™u c·ª±c ‚Üí Th√™m "T√¥i ƒëang c√≥ suy nghƒ© r·∫±ng..." ‚Üí T·∫°o kho·∫£ng c√°ch!
                </label>
            </div>
            
            <div class="checklist-item priority-low">
                <input type="checkbox" id="anytime5" onchange="updateStats()">
                <label for="anytime5">
                    <strong>Micro-destruction:</strong> L√†m 1 ƒëi·ªÅu nh·ªè kh√°c th∆∞·ªùng (ƒë∆∞·ªùng m·ªõi, m√≥n m·ªõi, ng∆∞·ªùi m·ªõi...) ƒë·ªÉ n√£o kh√¥ng ch√°n
                </label>
            </div>
        </div>

        <div class="emergency-box">
            <h3>üö® KHI KH·∫®N C·∫§P - G·ªåI NGAY!</h3>
            <ul>
                <li><strong>Hotline S·ª©c kh·ªèe t√¢m th·∫ßn:</strong> 1800 6969 (24/7, mi·ªÖn ph√≠)</li>
                <li><strong>2 ng∆∞·ªùi b·∫°n "gi·ªØ ch√¢n":</strong> T√™n: __________ SƒêT: __________</li>
                <li><strong>Ng∆∞·ªùi th√¢n tin c·∫≠y:</strong> T√™n: __________ SƒêT: __________</li>
            </ul>
        </div>

        <div class="notes-section">
            <h3>üìù GHI CH√ö H√îM NAY</h3>
            <textarea placeholder="C·∫£m x√∫c ƒë·∫∑c bi·ªát? Th√†nh t·ª±u nh·ªè? B√†i h·ªçc r√∫t ra? Vi·∫øt tho·∫£i m√°i..."></textarea>
        </div>

        <div class="quote">
            "M·ªói ng√†y ho√†n th√†nh checklist n√†y l√† m·ªói ng√†y b·∫°n ƒë√°nh b·∫°i phi√™n b·∫£n c≈© c·ªßa ch√≠nh m√¨nh. <br>
            Sau 90 ng√†y, b·∫°n s·∫Ω kh√¥ng c√≤n nh·∫≠n ra ng∆∞·ªùi trong g∆∞∆°ng!"
        </div>

        <button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è IN CHECKLIST</button>

        <!-- L·ªäCH S·ª¨ CHECK -->
        <div class="history-section no-print">
            <div class="section-title" style="border: none; padding: 0; margin-bottom: 10px;">
                <span class="section-icon">üìö</span>
                L·ªäCH S·ª¨ CHECK
            </div>

            <div class="history-controls">
                <button onclick="showHistory('all')" class="print-btn" style="background:#667eea; padding:8px 12px; font-size:14px; border-radius:8px;">Xem t·∫•t c·∫£</button>
                <button onclick="showHistory('90')" class="print-btn" style="background:#28a745; padding:8px 12px; font-size:14px; border-radius:8px;">90 ng√†y g·∫ßn nh·∫•t</button>
                <button onclick="exportHistory()" class="print-btn" style="background:#764ba2; padding:8px 12px; font-size:14px; border-radius:8px;">Xu·∫•t JSON</button>
                <button onclick="clearHistoryConfirm()" class="print-btn" style="background:#dc3545; padding:8px 12px; font-size:14px; border-radius:8px;">X√≥a l·ªãch s·ª≠</button>
            </div>

            <div id="historyList" class="history-list" aria-live="polite">
                <!-- items injected here -->
            </div>
            <div class="small-muted" style="margin-top:8px;">Ghi ch√∫: d·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô tr√™n tr√¨nh duy·ªát (localStorage). ƒê·ªÉ chia s·∫ª/ƒë·ªìng b·ªô, xu·∫•t JSON r·ªìi l∆∞u n∆°i an to√†n.</div>
        </div>

        <div style="text-align: center; color: #999; font-size: 12px; margin-top: 30px;">
            ¬© 2025 ‚Ä¢ H√†nh tr√¨nh 90 ng√†y t·ª± c·ª©u ch√≠nh m√¨nh
        </div>
    </div>

    <script>
        // T·ª± ƒë·ªông ƒëi·ªÅn ng√†y h√¥m nay
        document.getElementById('dateInput').valueAsDate = new Date();
        
        // C·∫≠p nh·∫≠t th·ªëng k√™ v√† l∆∞u tr·∫°ng th√°i (c√πng metadata: ng√†y th·ª©, ghi ch√∫, timestamp)
        function showSavedBadge() {
            const b = document.getElementById('savedBadge');
            if (!b) return;
            b.style.opacity = '1';
            clearTimeout(b._hideTimeout);
            b._hideTimeout = setTimeout(() => { b.style.opacity = '0'; }, 1600);
        }

        function updateStats() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const total = checkboxes.length;
            let completed = 0;

            const state = {};
            checkboxes.forEach(cb => {
                state[cb.id] = cb.checked;
                if (cb.checked) completed++;
            });

            const percent = Math.round((completed / total) * 100);

            document.getElementById('completedToday').textContent = completed;
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('percentComplete').textContent = percent + '%';

            // L∆∞u v√†o localStorage v·ªõi metadata
            const dateKey = document.getElementById('dateInput').value;
            if (dateKey) {
                const dayNumber = document.getElementById('dayNumber').value || '';
                const notesEl = document.querySelector('.notes-section textarea');
                const notes = notesEl ? notesEl.value : '';

                const saveObj = {
                    state: state,
                    meta: {
                        dayNumber: dayNumber,
                        notes: notes,
                        savedAt: (new Date()).toISOString()
                    }
                };

                try {
                    localStorage.setItem('checklist_' + dateKey, JSON.stringify(saveObj));
                    showSavedBadge();
                } catch (e) {
                    console.error('L·ªói l∆∞u localStorage', e);
                }
            }
        }
        
        // tiny debounce helper
        function debounce(fn, wait) {
            let t;
            return function(...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        // Kh√¥i ph·ª•c tr·∫°ng th√°i khi load l·∫°i trang
        window.addEventListener('load', function() {
            const dateKey = document.getElementById('dateInput').value;
            if (dateKey) {
                const raw = localStorage.getItem('checklist_' + dateKey);
                if (raw) {
                    try {
                        const parsed = JSON.parse(raw);
                        const state = parsed && parsed.state ? parsed.state : parsed;
                        Object.keys(state).forEach(id => {
                            const checkbox = document.getElementById(id);
                            if (checkbox) {
                                checkbox.checked = state[id];
                            }
                        });
                        // restore metadata if present
                        if (parsed && parsed.meta) {
                            if (parsed.meta.dayNumber) document.getElementById('dayNumber').value = parsed.meta.dayNumber;
                            const notesEl = document.querySelector('.notes-section textarea');
                            if (notesEl && parsed.meta.notes) notesEl.value = parsed.meta.notes;
                        }
                        updateStats();
                    } catch (e) {
                        console.error('L·ªói parse saved state', e);
                    }
                }
            }
            // attach auto-save for notes and dayNumber
            const notesEl = document.querySelector('.notes-section textarea');
            if (notesEl) notesEl.addEventListener('input', debounce(updateStats, 400));
            const dayNum = document.getElementById('dayNumber');
            if (dayNum) dayNum.addEventListener('change', updateStats);
        });
        
        // C·∫≠p nh·∫≠t khi ƒë·ªïi ng√†y
        document.getElementById('dateInput').addEventListener('change', function() {
            // B·ªè check t·∫•t c·∫£
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            // clear notes/dayNumber UI before load
            const notesEl = document.querySelector('.notes-section textarea'); if (notesEl) notesEl.value = '';
            document.getElementById('dayNumber').value = '';
            updateStats();

            // Load l·∫°i tr·∫°ng th√°i c·ªßa ng√†y m·ªõi
            window.dispatchEvent(new Event('load'));
            // refresh history list
            showHistory('90');
        });
        
        // Hi·ªáu ·ª©ng confetti khi ho√†n th√†nh 100%
        function checkComplete() {
            const percent = parseInt(document.getElementById('percentComplete').textContent);
            if (percent === 100) {
                alert('üéâ CH√öC M·ª™NG! B·∫°n ƒë√£ ho√†n th√†nh 100% checklist h√¥m nay! B·∫°n l√† chi·∫øn binh th·∫≠t s·ª±! üí™');
            }
        }
        
        // G·ªçi checkComplete m·ªói l·∫ßn update
        const originalUpdate = updateStats;
        updateStats = function() {
            originalUpdate();
            checkComplete();
        };

        // --- L·ªãch s·ª≠: scan localStorage, render v√† thao t√°c ---
        function getAllChecklistKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k && k.startsWith('checklist_')) keys.push(k);
            }
            return keys;
        }

        function parseDateFromKey(key) {
            // key format: checklist_YYYY-MM-DD
            return key.replace('checklist_', '');
        }

        function getStatsFromState(state) {
            const ids = Object.keys(state);
            const total = ids.length;
            let completed = 0;
            ids.forEach(id => { if (state[id]) completed++; });
            const percent = total ? Math.round((completed / total) * 100) : 0;
            return { total, completed, percent };
        }

        function daysBetween(dateA, dateB) {
            const msPerDay = 24 * 60 * 60 * 1000;
            return Math.floor((dateB - dateA) / msPerDay);
        }

        function showHistory(mode = '90') {
            const listEl = document.getElementById('historyList');
            listEl.innerHTML = '';

            const keys = getAllChecklistKeys();
            const entries = keys.map(k => {
                const d = parseDateFromKey(k);
                const raw = localStorage.getItem(k);
                let parsed = {};
                try { parsed = JSON.parse(raw) || {}; } catch (e) { parsed = {}; }
                const state = parsed && parsed.state ? parsed.state : parsed;
                const stats = getStatsFromState(state);
                return { key: k, date: d, stats, meta: parsed && parsed.meta ? parsed.meta : null };
            });

            // sort desc
            entries.sort((a,b) => b.date.localeCompare(a.date));

            const today = new Date();
            const limitDays = 90;

            entries.forEach(entry => {
                const entryDate = new Date(entry.date + 'T00:00:00');
                const age = daysBetween(entryDate, today);
                if (mode === '90' && age > limitDays) return; // skip older than 90 when in 90 mode

                const item = document.createElement('div');
                item.className = 'history-item' + (age >= limitDays ? ' old-90' : '');

                const left = document.createElement('div');
                left.innerHTML = `<strong>${entry.date}</strong><div class="small-muted">${age} ng√†y tr∆∞·ªõc</div>`;

                const right = document.createElement('div');
                right.innerHTML = `${entry.stats.completed}/${entry.stats.total} ‚Äî ${entry.stats.percent}%`;

                item.appendChild(left);
                item.appendChild(right);

                // click to load that day's state into the UI
                item.style.cursor = 'pointer';
                item.title = 'Nh·∫•p ƒë·ªÉ xem v√† t·∫£i tr·∫°ng th√°i v√†o giao di·ªán';
                item.addEventListener('click', () => {
                    const saved = localStorage.getItem(entry.key);
                    if (!saved) return;
                    let parsed = {};
                    try { parsed = JSON.parse(saved); } catch (e) { parsed = {}; }
                    const state = parsed && parsed.state ? parsed.state : parsed;
                    // clear current
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    Object.keys(state).forEach(id => {
                        const cb = document.getElementById(id);
                        if (cb) cb.checked = state[id];
                    });
                    document.getElementById('dateInput').value = entry.date;
                    // restore meta
                    if (parsed && parsed.meta) {
                        if (parsed.meta.dayNumber) document.getElementById('dayNumber').value = parsed.meta.dayNumber;
                        const notesEl = document.querySelector('.notes-section textarea');
                        if (notesEl && parsed.meta.notes) notesEl.value = parsed.meta.notes;
                    }
                    updateStats();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                listEl.appendChild(item);
            });

            if (entries.length === 0) {
                listEl.innerHTML = '<div class="small-muted">Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠. H√£y ho√†n th√†nh checklist h√¥m nay ƒë·ªÉ l∆∞u l·∫°i.</div>';
            }
        }

        function exportHistory() {
            const keys = getAllChecklistKeys();
            const out = {};
            keys.forEach(k => { out[k.replace('checklist_', '')] = JSON.parse(localStorage.getItem(k)); });
            const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'checklist-history.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function clearHistoryConfirm() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ checklist (d·ªØ li·ªáu localStorage)? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) return;
            const keys = getAllChecklistKeys();
            keys.forEach(k => localStorage.removeItem(k));
            showHistory('all');
            alert('ƒê√£ x√≥a l·ªãch s·ª≠.');
        }

        // show 90-day history on load
        window.addEventListener('load', function() {
            showHistory('90');
        });
    </script>
</body>
</html>
